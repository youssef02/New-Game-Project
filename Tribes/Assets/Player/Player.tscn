[gd_scene load_steps=6 format=2]

[ext_resource path="res://Assets/Player/particles/PlayerParticles.tscn" type="PackedScene" id=1]

[sub_resource type="GDScript" id=1]
script/source = "#Johann Massyn, 23/06/2019
#Godot (3.1) 3D Player movement script

#Atatch script to 3d node with following structure
#Kinematic body: Player
#  - CollisionShape: CollisionShape
#  - Camera: Camera

extends KinematicBody

export (bool) var can_move = true #Alow player to input movment.
export (bool) var can_sprint = true #Alow player to toggle sprint movment.
export (float) var move_speed = 16 #Players movement speed
export (float) var move_speed_sprint = 32 #Players sprint movement speed
export (bool) var move_sprint = false #Player sprinting toggle
export (float) var move_acceleration = 7 #Players acceleration to movment speed 
export (float) var move_deacceleration = 10 #Players deacceleration from movment speed
export (bool) var mouse_captured = true #Toggles mouse captured mode
export (float) var mouse_sensitivity_x = 0.3 #Mouse sensitivity X axis
export (float) var mouse_sensitivity_y = 0.3 #Mouse sensitivity Y axis
export (float) var mouse_max_up = 40 #Mouse max look angle up
export (float) var mouse_max_down = -30 #Mouse max look angle down
export (float) var Jump_speed = 12 #Players jumps speed
export (bool) var allow_fall_input = true #Alow player to input movment when falling
export (bool) var stop_on_slope = false #Toggle sliding on slopes
export (float) var max_slides = 4 #Maximum of slides
export (float) var floor_max_angle = 60 #Maximum slop angle player can traverse
export (bool) var infinite_inertia = false #Toggle infinite inertia
export (float) var gravaty = 20 #Gravaty acceleration
export (Vector3) var gravaty_vector = Vector3(0, -1, 0) #Gravaty normal direction vector
export (Vector3) var floor_normal = Vector3(0, 1, 0) #Floor normal direction vector
export (Vector3) var jump_vector = Vector3(0, 1, 0) #Jump normal direction vector
export (Vector3) var velocity = Vector3(0, 0, 0) #Initial velocity
export (bool) var double_jump = true #enable double jump
export (bool) var super_jump = false #enable super jump

var timer = null

func _ready():
	$MeshInstance/Particles.emitting = false
	$MeshInstance/Particles.restart()
	
	
	timer = Timer.new()
	
	timer.connect(\"timeout\",self,\"timeoutparticle\")
	add_child(timer)
	print(\"conected timer\")
	timer.one_shot = false
	
	if mouse_captured:
		Input.set_mouse_mode(Input.MOUSE_MODE_CAPTURED)
	
	pass
	
func timeoutparticle():
	print(\"timeout\")
	$MeshInstance/Particles.set_emitting(false)
	timer.stop()
	
	pass
	
func timeoutwalljump():
	pass

var shake_amount = 0.02
func _process(delta):
	$Spatial/Camera.set_h_offset(rand_range(-1.0, 1.0) * shake_amount)
	$Spatial/Camera.set_v_offset(rand_range(-1.0, 1.0) * shake_amount)
	
	pass
	

func _physics_process(delta):
	
	#player movement XY
	var dir = Vector3(0, 0, 0)
	if can_move and (is_on_floor() or allow_fall_input or is_on_wall()):
		
		#Left
		if Input.is_action_pressed(\"move_left\"):
			dir.x -= 1
			
		#Right
		if Input.is_action_pressed(\"move_right\"):
			dir.x += 1
			
		#Forward
		if Input.is_action_pressed(\"move_forward\"):
			dir.z -= 1;
		
		#Backwards	
		if Input.is_action_pressed(\"move_backwards\"):
			dir.z += 1
			
		#Jump
		
		var jump = Input.is_action_just_pressed(\"move_jump\")
		if jump and( is_on_floor() or is_on_wall()) :
			
			if is_on_floor():
				velocity += jump_vector * Jump_speed - (jump_vector * -1).normalized() * velocity.dot(jump_vector * -1)
			elif is_on_wall():
				var collision = get_slide_collision(0).normal
				velocity += collision * Jump_speed
				velocity += Vector3.UP * Jump_speed
		elif double_jump and jump:
			double_jump = false
			velocity += jump_vector * Jump_speed - (jump_vector * -1).normalized() * velocity.dot(jump_vector * -1)
		#Sprint toggle
		if can_sprint and Input.is_action_pressed(\"move_sprint\") and is_on_floor():
			move_sprint = true
			$MeshInstance/Particles.set_emitting(true)
			timer.set_wait_time(0.4)
			timer.start()
			
			
		if can_sprint and not Input.is_action_pressed(\"move_sprint\") and is_on_floor():
			move_sprint = false
	
	#Smooth movement
	dir = transform.basis.xform(dir.normalized()) * (move_speed_sprint if move_sprint else move_speed)
	
	if is_on_floor() or dir != Vector3(0, 0, 0):
		var acceleration = move_acceleration if dir.dot(velocity) else move_deacceleration
		var vp = gravaty_vector.normalized() * velocity.dot(gravaty_vector)
		velocity = (velocity - vp).linear_interpolate(dir, acceleration * delta) + vp
	
	#Gravaty
	if !is_on_floor():
		velocity += gravaty_vector * gravaty * delta
		
	#double jump
	if is_on_floor() or is_on_wall():
		double_jump = true
	
	
	#Player move
	
	move_and_slide(velocity, floor_normal, stop_on_slope, max_slides, deg2rad(floor_max_angle), infinite_inertia)
	
	#label text
	if OS.is_debug_build():
		$Spatial/Camera/Label.set_text(\"Fps: \"+str(Engine.get_frames_per_second())+\"\\nVelocity : \"+str(velocity.abs())+\"\\nJump : \"+str(double_jump))
	pass


func _input(event):
	#Mouse movement
	if event is InputEventMouseMotion and Input.get_mouse_mode() == Input.MOUSE_MODE_CAPTURED:
		rotation_degrees.y += -event.relative.x * mouse_sensitivity_x
		$Spatial.rotation_degrees.x = clamp($Spatial.rotation_degrees.x + -event.relative.y * mouse_sensitivity_y, mouse_max_down, mouse_max_up)
	pass


func _on_Cube001_super_jump(val):
	
	if val == true:
		super_jump = true
	else:
		 super_jump = false
	pass # Replace with function body.


func _on_jumppad_jumppad(val):
	if val == true:
		super_jump = true
	else:
		super_jump=false
	pass # Replace with function body.


func _on_jumppad_area_entered(area):
	print(\"hello\")
	pass # Replace with function body.
"

[sub_resource type="SpatialMaterial" id=2]
vertex_color_use_as_albedo = true
vertex_color_is_srgb = true
params_diffuse_mode = 1
params_specular_mode = 1
params_line_width = 8.6
params_point_size = 16.8
albedo_color = Color( 0.00392157, 0.54902, 0.984314, 1 )
emission_enabled = true
emission = Color( 0.184314, 0.207843, 1, 1 )
emission_energy = 0.0
emission_operator = 0
emission_on_uv2 = false
subsurf_scatter_enabled = true
subsurf_scatter_strength = 0.05

[sub_resource type="CubeMesh" id=3]
material = SubResource( 2 )

[sub_resource type="ConvexPolygonShape" id=4]
points = PoolVector3Array( -1, -1, -1, -1, -1, 1, -1, 1, -1, -1, 1, 1, 1, -1, -1, 1, -1, 1, 1, 1, -1, 1, 1, 1 )

[node name="Player" type="KinematicBody"]
collision_layer = 2147483650
script = SubResource( 1 )

[node name="MeshInstance" type="MeshInstance" parent="."]
mesh = SubResource( 3 )
material/0 = null

[node name="Particles" parent="MeshInstance" instance=ExtResource( 1 )]

[node name="CollisionShape" type="CollisionShape" parent="."]
shape = SubResource( 4 )

[node name="Spatial" type="Spatial" parent="."]

[node name="Camera" type="ClippedCamera" parent="Spatial"]
transform = Transform( 1, 0, 0, 0, 0.980965, 0.194183, 0, -0.194183, 0.980965, 0, 2.73682, 7.45405 )
far = 8192.0

[node name="Label" type="Label" parent="Spatial/Camera"]
margin_right = 70.0
margin_bottom = 25.0
custom_colors/font_color = Color( 0.980392, 0.00392157, 0.00392157, 1 )
text = "%Data%"
__meta__ = {
"_edit_use_anchors_": false
}
